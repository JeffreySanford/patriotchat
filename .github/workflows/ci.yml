name: CI Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CI: true

jobs:
  lint-test-build:
    name: Lint, Test, Guardrail & Containers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node & pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: Install dependencies
        run: pnpm install

      - name: Lint projects
        run: |
          echo "Running lint for known projects..."
          if [ -d "libs/shared" ]; then pnpm nx lint shared; else echo "No shared lib; skipping lint"; fi
          if [ -d "apps/frontend" ]; then pnpm nx lint frontend; else echo "No frontend app; skipping lint"; fi
          if [ -d "apps/api" ]; then pnpm nx lint api; else echo "No api app; skipping lint"; fi

      - name: Run ESLint rule tests
        run: pnpm run lint:rule-tests

      - name: Run typed ESLint rule tests (typed-lint)
        run: pnpm run lint:rule-tests:typed-lint || true

      - name: Run typed ESLint checks
        run: |
          pnpm run lint:rule-tests:typing || true
          pnpm run lint:typed || true
          # fail the job if any typed linting errors are found
          pnpm run lint:typed --silent || exit 1
      - name: Run unit tests (if present)
        run: |
          if [ -d "libs/shared" ]; then pnpm nx test shared; else echo "No unit tests found; skipping"; fi

      - name: Run API tests (if present)
        run: |
          if [ -d "apps/api" ]; then pnpm nx test api; else echo "No api app; skipping api tests"; fi

      - name: Run end-to-end suite (if present)
        run: |
          if [ -d "apps/frontend" ]; then pnpm nx e2e frontend-e2e || echo "E2E suite failed or not configured"; else echo "No frontend app; skipping e2e"; fi

      - name: Guardrail regression suite (if present)
        run: |
          if pnpm nx run guardrail-regressions --silent; then echo "Guardrail regressions ran"; else echo "No guardrail-regressions target; skipping"; fi

      - name: Build containers
        run: |
          if [ -f docker-compose.yml ]; then
            COMPOSE_PROJECT_NAME=patriotchat docker compose build --parallel
          else
            echo "No docker-compose.yml found; skipping container build"
          fi

      - name: Scan container images
        run: |
          if [ -f docker-compose.yml ]; then
            COMPOSE_PROJECT_NAME=patriotchat
            services=$(docker compose config --services)
            if [ -z "$services" ]; then
              echo "No services defined in docker-compose.yml"
              exit 0
            fi
            for service in $services; do
              image="$COMPOSE_PROJECT_NAME"_${service}
              echo "Scanning image $image"
              if docker image inspect "$image" > /dev/null 2>&1; then
                docker scan "$image" || true
              else
                echo "Image $image not found; skipping scan"
              fi
            done
          else
            echo "No docker-compose.yml found; skipping container scan"
          fi
